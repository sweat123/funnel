# overview

`kafka`作为一款优秀的消息队列，能够实时的传输大量的数据。并且现在越来越多的项目开始使用`kafka`。对`kafka`消费者和生产者的数据审计也越来越最重要。

作为使用`kafka`的使用方，我可能想知道，某个时间段内某个消费者从某个`topic`里消费了多少个消息，消息到达消费者应用的时候，延迟是多少；以及某个时间段内生产者发送了多少个消息到`topic`内。

基于这样的考虑，设计一款能够审计`KafkaProducer`和`KafkaConsumer`在某个时间段内消息接收、发送数量和延迟的工具。并且尽量减少对业务代码的侵入。

# 设计

## 概述
 
1. `kafka`在`0.10.x`版本之后开始引入了`interceptor`概念，`KafkaProducer`和`KafkaCosnumer`可以设置`interceptor`，让每个发送和收到的消息都经过相应的拦截器过滤。基于`interceptor`,
就可以通过对用户最少的侵入，来实现消息的审计。
2. `kafka`在`0.10.x`之后，每个消息都会带有一个时间戳。如果生产者发送消息时，没有带有时间戳，那么消息到达`kafka`服务器的时间戳会被添加到此消息上。基于消息带有的时间戳，就能够做到消息从`kafka`
服务器到消费者获取到消息这段时间的延迟。

## 详细设计

架构设计图

![http://or0f3pi7r.bkt.clouddn.com/18-7-26/38709579.jpg](http://or0f3pi7r.bkt.clouddn.com/18-7-26/38709579.jpg)

通过使用`Kafka`生产者和消费者的客户端，都接入`funnel`拦截器，`funnel`拦截器会对生产者生产的每条消息和消费者消费的每条消息进行处理，这个处理过程会是异步进行的，尽可能的不影响`kafka`本身的性能；
每条被`funnel interceptor`处理的消息，都会被计算分配到一个时间桶内，每个时间桶内会维护消息的个数，平均延迟等信息。这些信息最后会被发送到一个专门用于审计的`Topic`，审计系统会从
审计`Topic`读取数据，将元数据导入到`elsticsearch`，最后通过`grafana`展示元数据。

TODO